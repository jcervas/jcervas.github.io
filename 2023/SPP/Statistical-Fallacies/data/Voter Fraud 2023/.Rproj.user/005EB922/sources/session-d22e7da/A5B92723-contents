---
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
header-includes: 
   - \usepackage{wrapfig}
   - \usepackage{caption}
---

\captionsetup[figure]{labelformat=empty}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(cache = TRUE)
```


```{r}
# Required packages
library(tidyverse)
library(sf)
library(dplyr)
library(rgeos)
library(rgdal)
library(gridExtra)
library(viridis)

library(pdftools)
library(readxl)
library(janitor)
library(stringr)

library(tidycensus)
tidycensus::census_api_key("5f98a6c74bd7ae588481b45d22d48b487611ab89")

library(stargazer)
```

# Allegheny, PA
## Precinct Matching
```{r }
# Setting parameters and loading spatial data: Allegheny County, Pennsylvania

county_shapefile <- "tl_2021_us_county"
precinct_shapefile <- "PA/PA_Precinct"
county_code <- "003"
State_fips <- 42
County_GEOID <- 42003
block_shapefile <- "PA/PA_Block"
block_data_file <- "PA/census_block_data_PA.xlsx" # Census block data file name

BlockGroup_shapefile <- "PA/PA_2020_Blockgroup"
BlockGroup_data_file <- "PA/census_BlockGroup_data_PA.xlsx" # Census block group data file name

CRS <- 4326 # Doesn't appear to matter; but needs to be consistent for matching to work
poly2nb_snap <- 0.0005 # Tangent geometry snapping constant

us_county <- sf::st_read(county_shapefile) # County shape file for exterior matching
us_county_OGR <- sf::as_Spatial(us_county) # Spatial polygon copy needed for certain functions to work

State_Precinct <- sf::st_read(precinct_shapefile) # Loading precinct geometries: Pennsylvania

State_Precinct_County <- State_Precinct %>% # Subsetting specific county: Allegheny
    subset(COUNTYFP20 == county_code)

set.seed(2020)
```

# Border Precincts Identification
```{r }
# Identify adjacent counties: tangent to Allegheny

us_county_state <- us_county %>% # Subsetting state's county level geometries: Pennsylvania
  subset(STATEFP == State_fips)
row.names(us_county_state) <- NULL # Row numbers needed to be resequenced

us_county_state_OGR <- us_county_OGR %>% # Subsetting state's county level geometries in Spatial polygon
  subset(STATEFP == State_fips)

us_county_state_Adjacent_Matrix <- us_county_state_OGR %>% # Create logical matrix of which geometries are tangent
  rgeos::gTouches(byid = TRUE)
rownames(us_county_state_Adjacent_Matrix) <- us_county_state$GEOID # IDs set to match County shapefile
colnames(us_county_state_Adjacent_Matrix) <- us_county_state$GEOID

Adjacent_County_Geometry <- us_county_state[which( # subsetted adjacent counties: tangent to Allegheny
  as.data.frame(us_county_state_Adjacent_Matrix)[,which(us_county_state$GEOID == County_GEOID)]
  ),] %>% 
  dplyr::select(GEOID, geometry, COUNTYFP) # Only necessary variables
row.names(Adjacent_County_Geometry) <- NULL

State_Precinct_County_GEO <- State_Precinct_County %>% # Standardized columns for combination
  dplyr::rename(GEOID = GEOID20, COUNTYFP = COUNTYFP20) %>%
  dplyr::select(GEOID, geometry, COUNTYFP)
row.names(State_Precinct_County_GEO) <- NULL

Adjacent_County_Geometry_crs <- st_transform(Adjacent_County_Geometry, crs = CRS) # crs transformation (prevents errors)
State_Precinct_County_GEO_crs <- st_transform(State_Precinct_County_GEO, crs = CRS)
```

```{r}
# Identifying and filtering interior precincts

Precinct_and_County_Spatial <- rbind(Adjacent_County_Geometry_crs, State_Precinct_County_GEO_crs) %>% 
  sf::as_Spatial() # Combine precinct and county files

Adjacent_List_Interior <- spdep::poly2nb(sp::as.SpatialPolygons.PolygonsList(Precinct_and_County_Spatial@polygons), 
                                         snap = poly2nb_snap) # Creates list of adjacent interior geometries

Num_Adjacent_County <- nrow(Adjacent_County_Geometry_crs) # poly2nb creates nested list for each polygon - Only need exterior
In_Index <- numeric()
for(i in 1:Num_Adjacent_County){ # loop through the first three sub-lists and combine indices
  In_Index <- c(In_Index, Adjacent_List_Interior[[i]])
}
In_Index <- In_Index[In_Index > Num_Adjacent_County] # Exterior counties removed

Precinct_Interior <- rbind(Adjacent_County_Geometry_crs, State_Precinct_County_GEO_crs)[In_Index,] # Filtering interior border precincts

ggplot() +
  geom_sf(data = Precinct_Interior, color = "black", fill = "gray90") +
  geom_sf(data = subset(us_county, GEOID == County_GEOID), color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  theme(legend.position = "none")
```

```{r }
# Selecting precincts in exterior counties

State_Precinct_County_GEO_Exterior <- State_Precinct %>% # Subset precincts in adjacent counties
  subset(COUNTYFP20 %in% Adjacent_County_Geometry$COUNTYFP) %>%
  dplyr::rename(GEOID = GEOID20, COUNTYFP = COUNTYFP20) %>%
  dplyr::select(GEOID, geometry, COUNTYFP)

us_county_Chosen <- us_county %>% # Select geometry of chosen County: Allegheny
  subset(GEOID == County_GEOID) %>%
  dplyr::select(GEOID, geometry, COUNTYFP)

ggplot() +
  geom_sf(data = State_Precinct_County_GEO_Exterior, color = "black", fill = NA) +
  geom_sf(data = us_county_Chosen, color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  theme(legend.position = "none")
```

```{r }
# Identify and select exterior precincts

Precinct_and_County_Spatial <- rbind(us_county_Chosen, State_Precinct_County_GEO_Exterior) %>% 
  sf::as_Spatial() # Combine interior County with exterior precincts (In spatial format for matching)

Adjacent_List_Exterior <- spdep::poly2nb(sp::as.SpatialPolygons.PolygonsList(Precinct_and_County_Spatial@polygons), 
                                         snap = poly2nb_snap) # Create list of which geometries tangent which

Precinct_and_County_Spatial_sf <- rbind(us_county_Chosen, State_Precinct_County_GEO_Exterior) # Combine interior County with exterior precincts

Precinct_Exterior <- rbind(us_county_Chosen, State_Precinct_County_GEO_Exterior)[Adjacent_List_Exterior[[1]],] # Subset exterior border precincts (only first entry in list necessary: "[[1]],]")

ggplot() +
  geom_sf(data = Precinct_Exterior, color = "black", fill = "gray90") +
  geom_sf(data = subset(us_county,GEOID == County_GEOID), color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  theme(legend.position = "none")
```

```{r }
# Create a precinct matching data frame from exterior and interior precincts

Precinct_Exterior_crs <- st_transform(Precinct_Exterior, crs = CRS) # Consistent CRS required for matching
Precinct_Interior_crs <- st_transform(Precinct_Interior, crs = CRS)

Precinct_Border_Spatial <- rbind(Precinct_Exterior_crs, Precinct_Interior_crs) %>% 
  sf::as_Spatial() # Combine interior and exterior precincts in spatial format for matching

Adjacent_List_Border <- spdep::poly2nb(sp::as.SpatialPolygons.PolygonsList(Precinct_Border_Spatial@polygons), 
                                         snap = poly2nb_snap) # Create adjacency list for exterior and interior precincts

Precinct_Relational_Data <- data.frame(Precinct1_Index = numeric(), Precinct2_Index = numeric())
for(i in 1:length(Adjacent_List_Border)){ # Create two columns in a data frame from the adjacency list
  County_temp_data <- data.frame(Precinct1_Index = Adjacent_List_Border[[i]])
  County_temp_data$Precinct2_Index <- i
  Precinct_Relational_Data <- rbind(Precinct_Relational_Data, County_temp_data)
}

Precinct_Border_crs <- rbind(Precinct_Exterior_crs, Precinct_Interior_crs) # Combine interior and exterior precincts

Precinct_County_Key <- State_Precinct %>% # Create a key of which precincts belong to which County
  as.data.frame() %>% #                     (the same as Precinct_Border_crs but has different IDs)
  dplyr::select(COUNTYFP20, GEOID20) %>% 
  dplyr::rename(GEOID = GEOID20)
Precinct_County_Key <- Precinct_Border_crs %>% 
  dplyr::left_join(Precinct_County_Key, by = "GEOID") %>% 
  as.data.frame() %>% 
  dplyr::select(COUNTYFP20, GEOID)

# Converting index numbers into GEOID and county IDs
Precinct_Relational_Data$Precinct1_CountyCode <- Precinct_County_Key[as.numeric(Precinct_Relational_Data$Precinct1_Index),1]
Precinct_Relational_Data$Precinct2_CountyCode <- Precinct_County_Key[as.numeric(Precinct_Relational_Data$Precinct2_Index),1]
Precinct_Relational_Data$Precinct1 <- Precinct_County_Key[as.numeric(Precinct_Relational_Data$Precinct1_Index),2]
Precinct_Relational_Data$Precinct2 <- Precinct_County_Key[as.numeric(Precinct_Relational_Data$Precinct2_Index),2]

Precinct_Match_Data <- Precinct_Relational_Data %>% # Create data frame of matching precincts
  subset(Precinct1_CountyCode != Precinct2_CountyCode) %>% # Filtering out inter-county tangents
  subset(Precinct1_CountyCode == county_code | Precinct2_CountyCode == county_code) %>% # Filtering border tangents that are not of County of interest
  base::subset(Precinct2_CountyCode == county_code) # Remove duplicate marches

plot_PA_Precinct_Border_example <- ggplot() +
  geom_sf(data = Precinct_Exterior, color = "black", fill = "#d59d9e") +
  geom_sf(data = Precinct_Interior, color = "black", fill = "dodgerblue2") +
  geom_sf(data = subset(us_county, GEOID == County_GEOID), color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  ggtitle("Allegheny County, Pennsylvania") +
  labs(caption = "Figure i") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size=35),
        plot.caption = element_text(hjust = 0.5, size=20))

plot_PA_Precinct_Border_example
```

# Border Precinct Centroid & Lines Creation
```{r warning=FALSE, }
# Precinct centroids and cross County matching lines creation

Precinct_Centroid <- rbind(st_transform(Precinct_Exterior, crs = CRS), st_transform(Precinct_Interior, crs = CRS)) %>% 
  dplyr::select(GEOID, geometry) %>%
  mutate(geometry = st_point_on_surface(geometry)) # Convert border precinct shapes into centroids

df <- Precinct_Match_Data %>% # Adding centroid data to data frame of matching precincts
  left_join(Precinct_Centroid, by = c("Precinct1" = "GEOID")) %>% 
  left_join(Precinct_Centroid, by = c("Precinct2" = "GEOID"))
mach_lines <- st_sfc(mapply(function(a,b){st_cast(st_union(a,b),"LINESTRING")}, # Create lines spanning between precinct pairs
                                df$geometry.x, df$geometry.y, SIMPLIFY=FALSE), crs = CRS)

plot_PA_Precinct_mach_lines <- ggplot() +
  geom_sf(data = Precinct_Exterior, color = "black", fill = "gray90") +
  geom_sf(data = Precinct_Interior, color = "black", fill = "gray80") +
  geom_sf(data = subset(us_county, GEOID == County_GEOID), color = "red", fill = NA) +
  geom_sf(data = mach_lines, color = "blue", fill = "gray90") +
  geom_sf(data = Precinct_Centroid, color = "black", fill = "gray90") +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  ggtitle("Allegheny")+
  theme(legend.position = "none")

plot_PA_Precinct_mach_lines
```

# Wall Test Precinct Centroid & Lines Creation
```{r}
# Precinct centroids and recessed County matching lines creation

State_Precinct_County_Spatial <- State_Precinct_County %>% # Convert County precincts into spatial format for matching
  sf::as_Spatial()
Adjacent_Precinct_County <- spdep::poly2nb(sp::as.SpatialPolygons.PolygonsList(State_Precinct_County_Spatial@polygons), 
                                         snap = poly2nb_snap) # Create adjacency list for County precincts

length_index <- sapply(Adjacent_Precinct_County, length) # Convert index of list into column for data frame
length_index_vec <- numeric(0)
for (i in 1:length(length_index)) {
  vec <- numeric(length_index[i])
  vec[1:length_index[i]] <- i
  length_index_vec <- c(length_index_vec, vec)
}

Adjacent_Precinct_County_Wall <- Adjacent_Precinct_County %>% # Create adjacency data frame for recessed precincts
  unlist() %>% 
  cbind(length_index_vec) %>% # Fully convert adjacency list into two columns
  as.data.frame() %>% 
  janitor::clean_names() %>% 
  dplyr::rename(GEOID_B = x, GEOID_C = length_index_vec) %>%
  dplyr::mutate(GEOID_B = State_Precinct_County$GEOID20[GEOID_B],
                GEOID_C = State_Precinct_County$GEOID20[GEOID_C]) %>% # Replace row IDs with precinct GEOIDs
  base::subset(GEOID_B %in% Precinct_Interior$GEOID) %>% # Define first column as only including border precincts
  base::subset(!GEOID_C %in% Precinct_Interior$GEOID) # Remove border precincts from second column

Precinct_Centroid_2nd <- rbind(st_transform(subset(State_Precinct_County,
                                                   GEOID20 %in% unique(Adjacent_Precinct_County_Wall$GEOID_C)), crs = CRS), 
                           st_transform(subset(State_Precinct_County, 
                                               GEOID20 %in% unique(Adjacent_Precinct_County_Wall$GEOID_B)), crs = CRS)) %>% 
  dplyr::select(GEOID20, geometry) %>%
  mutate(geometry = st_point_on_surface(geometry)) # Convert recessed precinct shapes into centroids

df <- Adjacent_Precinct_County_Wall %>%  # Adding centroid data to data frame of matching precincts
  left_join(Precinct_Centroid_2nd, by = c("GEOID_B" = "GEOID20")) %>% 
  left_join(Precinct_Centroid_2nd, by = c("GEOID_C" = "GEOID20"))
mach_lines_2nd <- st_sfc(mapply(function(a,b){st_cast(st_union(a,b),"LINESTRING")}, # Create lines between precinct pairs
                                df$geometry.x, df$geometry.y, SIMPLIFY=FALSE), crs = CRS)

plot_PA_Precinct_mach_lines <- ggplot() +
  geom_sf(data = subset(State_Precinct_County, GEOID20 %in% unique(Adjacent_Precinct_County_Wall$GEOID_C)), 
          color = "black", fill = "dodgerblue4") +
  geom_sf(data = Precinct_Exterior, color = "black", fill = "#d59d9e") +
  geom_sf(data = Precinct_Interior, color = "black", fill = "dodgerblue2") +
  geom_sf(data = subset(us_county, GEOID == County_GEOID), color = "red", fill = NA) +
  geom_sf(data = mach_lines_2nd, color = "magenta3") +
  geom_sf(data = Precinct_Centroid_2nd, color = "gray15") +
  geom_sf(data = mach_lines, color = "deepskyblue1") +
  geom_sf(data = Precinct_Centroid, color = "gray15") +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  ggtitle("Allegheny County, Pennsylvania") +
  labs(caption = "Figure iii") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size=35),
        plot.caption = element_text(hjust = 0.5, size=20))
plot_PA_Precinct_mach_lines
```

```{r}
# Aggregate block level census data to precinct level

All_COUNTYFP <- unique(Precinct_Border_crs$COUNTYFP) # Vector of all county codes
Wall_conglomerate_Precinct <- State_Precinct %>% # Select precincts in all counties
  base::subset(COUNTYFP20 %in% All_COUNTYFP) %>% 
  st_transform(crs = CRS) %>% 
  dplyr::rename(GEOID = GEOID20, COUNTYFP = COUNTYFP20)

census_block_variables <- c("P3_001N", "P3_004N", "P3_006N", "P4_002N", "P3_009N") # Census block variables for aggregation
tot_pop_var <- "P3_001N"
# tidycensus::get_decennial(geography = "block", # Un-comment to re-download data
#                     variables = census_block_variables, 
#                     year = 2020,
#                     # summary_var = "P001001", 
#                     state = "42", 
#                     county = All_COUNTYFP, 
#                     geometry = FALSE) %>% 
#   pivot_wider(names_from = variable,
#               values_from = c(value)) %>% 
#   openxlsx::write.xlsx(file = block_data_file, rowNames = FALSE, overwrite = TRUE)
census_block_data <- read_excel(block_data_file) %>% # Read census data
  dplyr::select(c("GEOID", census_block_variables))

sf::sf_use_s2(FALSE) # This is required to fix an error (does not appear to affect results)
County_blocks <- sf::st_read(block_shapefile) %>%
  dplyr::rename(GEOID20_census = GEOID20) %>% 
  right_join(census_block_data, by = c("GEOID20_census" = "GEOID")) %>% # Combine Census data with block geography
  base::subset(COUNTYFP20 %in% All_COUNTYFP) %>% # Select blocks for all relevant counties
  st_transform(crs = CRS) %>% 
  dplyr::mutate(area_original = st_area(geometry)) # Measure the original area of the blocks

Block_overlap <- sf::st_intersection(Wall_conglomerate_Precinct, County_blocks) %>% # Area Calculation
  dplyr::mutate(area_modified = st_area(geometry), area_multiplier = as.numeric(area_modified / area_original)) %>%
  sf::st_drop_geometry() # Trims blocks into respective precincts and assigns precinct ID to block
Block_overlap$area_multiplier[Block_overlap$area_multiplier > 1] <- 1 # Fixes apparent rounding error
Block_overlap[census_block_variables] <- Block_overlap[,census_block_variables] * Block_overlap[,"area_multiplier"] # Adjusts variables by proportion of precinct overlap

Block_overlap_summarise <- Block_overlap %>% # Sum blocks to precinct level
  dplyr::group_by(GEOID) %>% 
  dplyr::summarise_at(vars(census_block_variables), sum, na.rm = TRUE) %>% 
  right_join(Wall_conglomerate_Precinct, by = "GEOID") %>% 
  as.data.frame() %>% 
  dplyr::mutate(Minority = (P3_004N + P3_006N + P4_002N) / P3_001N, # Create minority variable and addreess undefined values
                Minority = ifelse(is.infinite(Minority), 0, Minority))

ggplot() + # Observe block aggregation
  geom_sf(data = Block_overlap_summarise, color = "black", aes(fill = Minority, geometry = geometry)) +
  geom_sf(data = subset(us_county, GEOID %in% c("42129", "42019", "42007", "42125", "42003")), color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = FALSE)+
  theme(legend.position = "none")
```

```{r}
# Block group variables

census_BlockGroup_variables <- c(
                            "B28002_001", # Internet Access (Estimate!!Total:)
                            "B28002_013", # Internet Access (Estimate!!Total:!!No Internet access)
                            "B01002_001",	# Estimate!!Median age --!!Total
                            "B19013_001",	# Estimate!!Median household income in the past 12 months (in 2020 inflation-adjusted dollars)
                            
                            # "B25046_001", # Estimate!!Aggregate number of vehicles available:
                            
                            "B25045_001", # Estimate!!Total:
                            "B25045_012", # Estimate!!Total:!!Renter occupied:!!No vehicle available:
                            "B25045_003", # Estimate!!Total:!!Owner occupied:!!No vehicle available:
                            
                            "B14007_001", # SCHOOL ENROLLMENT BY DETAILED  LEVEL OF SCHOOL FOR THE POPULATION 3 YEARS AND OVER: Total:
                            "B14007_002" # SCHOOL ENROLLMENT BY DETAILED  LEVEL OF SCHOOL FOR THE POPULATION 3 YEARS AND OVER: Enrolled in school:
                            ) # Census block variables for aggregation
# tidycensus::get_acs(geography = "block group", # Un-comment to re-download data
#                     variables = census_BlockGroup_variables,
#                     year = 2020,
#                     state = "42",
#                     county = All_COUNTYFP,
#                     geometry = FALSE,
#                     survey = "acs5",
#                     cache_table = TRUE) %>%
#   dplyr::select(!moe) %>%
#   pivot_wider(names_from = variable,
#               values_from = c(estimate)) %>%
#   openxlsx::write.xlsx(file = "PA/census_BlockGroup_data_PA.xlsx", rowNames = FALSE, overwrite = TRUE)
census_BlockGroup_data <- read_excel(BlockGroup_data_file) %>% # Read census block group data
  dplyr::rename(Age = B01002_001, income = B19013_001) %>% 
  dplyr::mutate_all(.funs = list(~ ifelse(is.na(.) == TRUE, rnorm( # Replace missing values with randomized median
    sum(is.na(.) == TRUE), 
    mean = median(., na.rm = TRUE), 
    sd = sd(., na.rm = TRUE)), .)))


census_BlockGroup_variables <- c("Age", "income", "B28002_013", "B28002_001", # Redefine variable list
                                 "B25045_001", "B25045_012", "B25045_003",
                                 "B14007_001", "B14007_002")

sf::sf_use_s2(FALSE) # This is required to fix an error (does not appear to affect results)
County_BlockGroup <- sf::st_read(BlockGroup_shapefile) %>%
  dplyr::rename(GEOID20_census = GEOID) %>% 
  right_join(census_BlockGroup_data, by = c("GEOID20_census" = "GEOID")) %>% # Combine Census data with block geography
  base::subset(COUNTYFP %in% All_COUNTYFP) %>% # Select blocks for all relevant counties
  st_transform(crs = CRS) %>% 
  dplyr::mutate(area_original = st_area(geometry)) # Measure the original area of the blocks

BlockGroup_overlap <- sf::st_intersection(Wall_conglomerate_Precinct, County_BlockGroup) %>% # Area Calculation
  dplyr::mutate(area_modified = st_area(geometry), area_multiplier = as.numeric(area_modified / area_original)) %>%
  sf::st_drop_geometry() # Trims blocks into respective precincts and assigns precinct ID to block
BlockGroup_overlap$area_multiplier[BlockGroup_overlap$area_multiplier > 1] <- 1 # Fixes apparent rounding error
BlockGroup_overlap[census_BlockGroup_variables] <- BlockGroup_overlap[,census_BlockGroup_variables] * BlockGroup_overlap[,"area_multiplier"] # Adjusts variables by proportion of precinct overlap

BlockGroup_overlap_summarise <- BlockGroup_overlap %>% # Sum blocks to precinct level
  dplyr::group_by(GEOID) %>% 
  dplyr::summarise_at(vars(census_BlockGroup_variables), sum, na.rm = TRUE) %>% 
  dplyr::select(c("GEOID"), census_BlockGroup_variables) %>% 
  right_join(Block_overlap_summarise, by = "GEOID") %>% 
  as.data.frame() %>% 
  dplyr::mutate(Internet = B28002_013 / B28002_001, # Create proportion variables and replace undefined values
                Internet = ifelse(is.infinite(Internet), 0, Internet),
                vehicle = (B25045_012 + B25045_003) / B25045_001,
                vehicle = ifelse(is.infinite(vehicle), 0, vehicle),
                School = B14007_002 / B14007_001,
                School = ifelse(is.infinite(School), 0, School))

census_block_variables = c("Minority", "Age", "income", "Internet", "vehicle", "School") # Redefine census variable list
```

```{r}
# Observe block group variables and aggregation

ggplot() +
  geom_sf(data = County_BlockGroup, color = "black", aes(fill = (B25045_012 + B25045_003) / B25045_001, geometry = geometry)) +
  geom_sf(data = subset(us_county, GEOID %in% c("42129", "42019", "42007", "42125", "42003")), color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = FALSE)+
  theme(legend.position = "none")

ggplot() +
  geom_sf(data = BlockGroup_overlap_summarise, color = "black", aes(fill = Minority, geometry = geometry)) +
  geom_sf(data = subset(us_county, GEOID %in% c("42129", "42019", "42007", "42125", "42003")), color = "red", fill = NA) +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = FALSE)+
  theme(legend.position = "none")
```

# Precinct matching

```{r}
# IS ALL JUST "Precinct_Match_Data"

length_index <- sapply(Adjacent_List_Border, length)

length_index_vec <- numeric(0)

for (i in 1:length(length_index)) {
  vec <- numeric(length_index[i])
  vec[1:length_index[i]] <- i
  length_index_vec <- c(length_index_vec, vec)
}

Adjacent_Border <- Adjacent_List_Border %>% 
  unlist() %>% 
  cbind(length_index_vec) %>% 
  as.data.frame() %>% 
  janitor::clean_names() %>% 
  dplyr::rename(GEOID_A = x, GEOID_B = length_index_vec) %>% 
  dplyr::mutate(COUNTY_A = Precinct_Border_Spatial$COUNTYFP[GEOID_A],
                COUNTY_B = Precinct_Border_Spatial$COUNTYFP[GEOID_B],
                GEOID_A = Precinct_Border_Spatial$GEOID[GEOID_A], 
                GEOID_B = Precinct_Border_Spatial$GEOID[GEOID_B]) %>% 
  base::subset(COUNTY_A != COUNTY_B) %>% 
  base::subset(COUNTY_B == county_code)
```

## Absentee data
```{r}
# Translation tables
Allegheny_Translation <- readxl::read_excel("PA/Absentee/Translation_Tables/Allegheny_Translation.xlsx") %>% 
  dplyr::rename(precinct = voter) %>% 
  dplyr::mutate(County = "Allegheny") %>% 
  dplyr::select(c("precinct", "County", "Border", "VTDST20"))
Beaver_Translation <- readxl::read_excel("PA/Absentee/Translation_Tables/Beaver_Translation.xlsx") %>% 
  dplyr::rename(precinct = voter) %>% 
  dplyr::mutate(County = "Beaver") %>% 
  dplyr::select(c("precinct", "County", "Border", "VTDST20"))
Butler_Table <- readxl::read_excel("PA/Absentee/Translation_Tables/Butler_Table.xlsx") %>% 
  dplyr::rename(precinct = voter) %>% 
  dplyr::mutate(County = "Butler") %>% 
  dplyr::select(c("precinct", "County", "Border", "VTDST20"))
Washington_Translation <- readxl::read_excel("PA/Absentee/Translation_Tables/Washington_Translation.xlsx") %>% 
  dplyr::rename(precinct = voter) %>% 
  dplyr::mutate(County = "Washington") %>% 
  dplyr::select(c("precinct", "County", "Border", "VTDST20"))
Westmoreland_Translation <- readxl::read_excel("PA/Absentee/Translation_Tables/Westmoreland_Translation.xlsx") %>% 
  dplyr::rename(precinct = voter) %>% 
  dplyr::mutate(County = "Westmoreland") %>% 
  dplyr::select(c("precinct", "County", "Border", "VTDST20"))

Translation <- dplyr::bind_rows(Allegheny_Translation, 
                                Beaver_Translation, 
                                Butler_Table, 
                                Washington_Translation, 
                                Westmoreland_Translation)
rm(Allegheny_Translation, Beaver_Translation, Butler_Table, Washington_Translation, Westmoreland_Translation)
```

```{r}
Conglomerate_Absentee <- read_excel("PA/Allegheny_Conglomerate_Absentee.xlsx") %>% # Read election results data and create relevant variables
  mutate(total_election_day = jb_election_day + dt_election_day + ind_election_day,
         Porp_Absentee = total_absentee / total_votes,
         Porp_Trump = (dt_election_day + dt_absentee + dt_provisional) / total_votes,
         Porp_Trump_election_day = dt_election_day / total_election_day,
         Porp_Trump_Absentee = dt_absentee / total_absentee)
Conglomerate_Absentee_variables <- c("Porp_Absentee", "Porp_Trump", "Porp_Trump_Absentee", "Porp_Trump_election_day")

Conglomerate_Absentee <- Conglomerate_Absentee %>% # Combine election results with geographically calculated data
  dplyr::left_join(Translation, by = c("County", "precinct"))

ggplot(Conglomerate_Absentee, aes(y = Porp_Trump_Absentee, x = Porp_Trump_election_day, color = County))+
  geom_point()+
  geom_smooth(method = 'lm', formula = y ~ x)+
  geom_point(aes(x = Porp_Trump_election_day, y = Porp_Trump_Absentee, color = County),
             data = subset(Conglomerate_Absentee, Border == "Border"))+
  geom_point(aes(x = Porp_Trump_election_day, y = Porp_Trump_Absentee), color = "yellow", shape = 1,
             data = subset(Conglomerate_Absentee, Border == "Border"))+
  theme_light()+
  ggtitle("Absentee % Vs Trump Vote; Allegheny & Surrounding Counties, Pennsylvania")+
  labs(y = "% Total Votes Mailed In", 
       x = "% Votes for Trump Out of Total",
       subtitle = "By Precinct, 2020 Presidential Election",
       caption = quote(NULL))+
  scale_colour_manual(values=c("darkblue", "darkorange3" ,"coral","firebrick1","firebrick4"))
```

```{r}
Conglomerate_Absentee_data <- Conglomerate_Absentee %>% # Combine Election results with census data
  dplyr::mutate(County_CAP = toupper(County)) %>% 
  dplyr::left_join(dplyr::select(sf::st_drop_geometry(State_Precinct), c("VTDST20", "GEOID20", "CTYNAME")),
                   by = c("County_CAP" = "CTYNAME", "VTDST20")) %>% 
  dplyr::left_join(dplyr::select(BlockGroup_overlap_summarise, c("GEOID", census_block_variables)),
                   by = c("GEOID20" = "GEOID")) %>% 
  dplyr::distinct(GEOID20, .keep_all = TRUE)

Conglomerate_Absentee_Border <- Conglomerate_Absentee_data %>% # Subset border precincts
  subset(Border == "Border") %>% 
    mutate(Border_lm = replace(Border, is.na(Border), "Interior"), 
           County_lm = replace(County, County != "Allegheny", "Exterior"))

plot_PA_Abs_EDV_UP <- ggplot(Conglomerate_Absentee_Border,
                                           aes(y = Porp_Trump_Absentee, x = Porp_Trump_election_day, color = County_lm))+
  geom_point()+
  theme_light()+
  ggtitle("Figure 1: Trump % Absentee Vs Election-Day Vote; Allegheny & Surrounding County Border Precincts")+
  labs(
    y = "% of Mail-In Votes for Trump out of Total Mail-In Ballots Cast",
       x = "% of Election-Day Votes for Trump out of Total Election-Day Ballots Cast",
       subtitle = "2020 Presidential Election",
       caption = quote(NULL),
       color = "Border Precincts")+
  scale_colour_manual(values=c("darkblue", "firebrick1"))+
  scale_y_continuous(labels = scales::percent)+
  scale_x_continuous(labels = scales::percent)+
  theme(legend.position='top')
plot_PA_Abs_EDV_UP
```


## Match analysis
```{r }
mach_O <- Conglomerate_Absentee_data %>% # Combine outer precincts with data
  dplyr::select(c("GEOID20", Conglomerate_Absentee_variables, census_block_variables)) %>% 
  dplyr::right_join(dplyr::select(Adjacent_Border, GEOID_A), by = c("GEOID20" = "GEOID_A")) %>% 
  dplyr::select(!GEOID20)

mach_I <- Conglomerate_Absentee_data %>% # Combine inner precincts with data
  dplyr::select(c("GEOID20", Conglomerate_Absentee_variables, census_block_variables)) %>% 
  dplyr::right_join(dplyr::select(Adjacent_Border, GEOID_B), by = c("GEOID20" = "GEOID_B")) %>% 
  dplyr::select(!GEOID20)

Precinct_match_data <- (mach_I - mach_O) %>% na.omit # Appears to be inner precincts minus outer precincts

ggplot()+
  geom_point(aes(x = Porp_Trump, y = Porp_Absentee), data = Precinct_match_data)+
  geom_smooth(aes(x = Porp_Trump, y = Porp_Absentee), data = Precinct_match_data, 
              method = 'lm', formula = y ~ x)+
  theme_light()+
  ggtitle("Absentee % Vs Trump Vote; Allegheny & Surrounding Counties, Pennsylvania")+
  labs(y = "% Total Votes Mailed In", 
       x = "% Votes for Trump Out of Total",
       subtitle = "By Precinct, 2020 Presidential Election",
       caption = quote(NULL))
```

## PA Berlin Wall Test (Precinct)
```{r }
State_Precinct_County_Spatial <- State_Precinct_County %>% # Convert precincts to spatial format for matching
  sf::as_Spatial()

Adjacent_Precinct_County_Wall <- spdep::poly2nb(sp::as.SpatialPolygons.PolygonsList(State_Precinct_County_Spatial@polygons), 
                                         snap = poly2nb_snap) # Initialize matching list

# precinct matching pairs
length_index <- sapply(Adjacent_Precinct_County_Wall, length) # Create matched precinct column
length_index_vec <- numeric(0)
for (i in 1:length(length_index)) {
  vec <- numeric(length_index[i])
  vec[1:length_index[i]] <- i
  length_index_vec <- c(length_index_vec, vec)
}

Adjacent_Precinct_County_Wall <- Adjacent_Precinct_County_Wall %>% # Create inner ring match list
  unlist() %>% cbind(length_index_vec) %>% # Create Counterpart matched precinct column
  as.data.frame() %>% 
  janitor::clean_names() %>% 
  dplyr::rename(GEOID_B = x, GEOID_C = length_index_vec) %>%
  dplyr::mutate(GEOID_B = State_Precinct_County$GEOID20[GEOID_B],
                GEOID_C = State_Precinct_County$GEOID20[GEOID_C]) %>% 
  base::subset(GEOID_B %in% Precinct_Interior$GEOID) %>% 
  base::subset(!GEOID_C %in% Precinct_Interior$GEOID)

# Centroid initialization (for plots)
Precinct_Centroid_2nd <- rbind(st_transform(subset(State_Precinct_County, 
                                                   GEOID20 %in% unique(Adjacent_Precinct_County_Wall$GEOID_C)), crs = CRS), 
                           st_transform(subset(State_Precinct_County, 
                                               GEOID20 %in% unique(Adjacent_Precinct_County_Wall$GEOID_B)), crs = CRS)) %>% 
  dplyr::select(GEOID20, geometry) %>%
  mutate(geometry = st_point_on_surface(geometry))

df <- Adjacent_Precinct_County_Wall %>% 
  left_join(dplyr::rename(Precinct_Centroid_2nd, GEOID_B = GEOID20), by = c("GEOID_B")) %>% 
  left_join(dplyr::rename(Precinct_Centroid_2nd, GEOID_C = GEOID20), by = c("GEOID_C"))

mach_lines_2nd <- st_sfc(mapply(function(a,b){st_cast(st_union(a,b),"LINESTRING")}, # Create lines for plots
                                df$geometry.x, df$geometry.y, SIMPLIFY=FALSE), crs = CRS)

plot_PA_Precinct_mach_lines <- ggplot() +
  geom_sf(data = subset(State_Precinct_County, GEOID20 %in% unique(Adjacent_Precinct_County_Wall$GEOID_C)), 
          color = "black", fill = "dodgerblue4") +
  geom_sf(data = Precinct_Exterior, color = "black", fill = "#d59d9e") +
  geom_sf(data = Precinct_Interior, color = "black", fill = "dodgerblue2") +
  geom_sf(data = subset(us_county, GEOID == County_GEOID), color = "red", fill = NA) +
  geom_sf(data = mach_lines_2nd, color = "magenta3") +
  geom_sf(data = Precinct_Centroid_2nd, color = "gray15") +
  geom_sf(data = mach_lines, color = "deepskyblue1") +
  geom_sf(data = Precinct_Centroid, color = "gray15") +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  ggtitle("Allegheny County, Pennsylvania") +
  labs(caption = "Figure iii") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size=35),
        plot.caption = element_text(hjust = 0.5, size=20))
plot_PA_Precinct_mach_lines

# Adjacent_Precinct_County_Wall

mach_2nd <- Conglomerate_Absentee_data %>% # call inner ring Precincts
  dplyr::select(c("GEOID20", Conglomerate_Absentee_variables, census_block_variables)) %>% 
  dplyr::right_join(dplyr::select(Adjacent_Precinct_County_Wall, GEOID_C), by = c("GEOID20" = "GEOID_C")) %>% 
  dplyr::select(!GEOID20)

mach_I_2 <- Conglomerate_Absentee_data %>% # call interior Precincts
  dplyr::select(c("GEOID20", Conglomerate_Absentee_variables, census_block_variables)) %>% 
  dplyr::right_join(dplyr::select(Adjacent_Precinct_County_Wall, GEOID_B), by = c("GEOID20" = "GEOID_B")) %>% 
  dplyr::select(!GEOID20)

Precinct_match_data_2nd <- (mach_I_2 - mach_2nd) %>% na.omit # interior Precincts - inner ring Precincts

ggplot()+
  geom_point(aes(x = Porp_Trump, y = Porp_Absentee), data = Precinct_match_data_2nd)+
  geom_smooth(aes(x = Porp_Trump, y = Porp_Absentee), data = Precinct_match_data_2nd, 
              method = 'lm', formula = y ~ x)+
  theme_light()+
  ggtitle("Absentee % Vs Trump Vote; Allegheny & Surrounding Counties, Pennsylvania")+
  labs(y = "% Total Votes Mailed In", 
       x = "% Votes for Trump Out of Total",
       subtitle = "By Precinct, 2020 Presidential Election",
       caption = quote(NULL))

ggplot() +
  geom_sf(data = State_Precinct_County_GEO, color = "black", fill = "gray90") +
  coord_sf()+
  theme_void()+
  scale_fill_viridis(discrete = TRUE)+
  theme(legend.position = "none")

# Combine both rings of differences into one data frame
Precinct_match_data$ring <- "1st"
Precinct_match_data_2nd$ring <- "2nd"
Precinct_match_data_3rd <- rbind(Precinct_match_data, Precinct_match_data_2nd)
Precinct_match_data_3rd$ring <- factor(Precinct_match_data_3rd$ring, 
                                       levels = c("1st", "2nd"),
                                      labels = c("Exterior", "Recessed"))
```

```{r }
# Figure 3 plot
plot_PA_Abs_EDV_Diff <- ggplot(Precinct_match_data_3rd, 
                               aes(y = Porp_Trump_Absentee, x = Porp_Trump_election_day, color = ring))+
  geom_point()+
  theme_light()+
  ggtitle("Figure 3: Difference in Trump Absentee Vs In-Person Share; Allegheny Exterior & Recessed Paired Precincts")+
  labs(y = "Difference in % of Mail-In Ballots for Trump", 
       x = "Difference in % of Election-Day Ballots for Trump",
       subtitle = "Across Adjacent Precincts, 2020 Presidential Election",
       caption = quote(NULL),
       color = "Precinct Difference")+
  scale_colour_manual(values=c("#c84c42", "#417ddd"))+
  scale_y_continuous(labels = scales::percent)+
  scale_x_continuous(labels = scales::percent)+
  theme(legend.position='top')
plot_PA_Abs_EDV_Diff
```

```{r}
save(Conglomerate_Absentee_Border, # Save model data
     Precinct_match_data_3rd,
          file = "PA/PA_model_data.Rdata")

save(plot_PA_Precinct_Border_example, # Save plots
     plot_PA_Precinct_mach_lines, 
     plot_PA_Abs_EDV_UP,
     plot_PA_Abs_EDV_Diff,
          file = "PA/PA_plots.Rdata")
```